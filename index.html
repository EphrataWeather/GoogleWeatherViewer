<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Google Weather API Data Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: radial-gradient(circle at top left, #0f172a, #020617);
            background-attachment: fixed;
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px) saturate(160%);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .metric-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.08);
        }

        .glow-text {
            text-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .forecast-scroll {
            display: flex;
            overflow-x: auto;
            gap: 0.75rem;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .forecast-scroll::-webkit-scrollbar { display: none; }

        .radar-container {
            position: relative;
            width: 100%;
            height: 350px; /* Fixed height for mobile usability */
            border-radius: 1.25rem;
            overflow: hidden;
            background: #000;
            touch-action: pan-x pan-y;
        }

        @media (min-width: 1024px) {
            .radar-container {
                height: 0;
                padding-top: 56.25%; /* 16:9 for desktop */
            }
        }

        .radar-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .wind-arrow-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.1);
            border: 1.5px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
        }

        /* Prevent layout shift on load */
        #dashboard-content {
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-slate-100 min-h-screen">

    <!-- Main Container -->
    <div class="flex flex-col lg:flex-row min-h-screen lg:h-screen lg:overflow-hidden max-w-[1600px] mx-auto">
        
        <!-- Sidebar / Top Header -->
        <aside class="w-full lg:w-80 glass-panel lg:border-r border-b border-white/5 p-6 lg:p-8 flex flex-col shrink-0">
            <div class="flex items-center justify-between lg:block mb-6 lg:mb-8">
                <div class="flex items-center gap-3">
                    <div class="p-2.5 bg-indigo-600 rounded-xl shadow-lg">
                        <i data-lucide="map-pin" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 id="location-name" class="text-lg font-black tracking-tight truncate w-32 md:w-48 lg:w-32">Akron, PA</h1>
                        <p class="text-[9px] text-slate-500 uppercase font-bold tracking-widest">Atmospheric Node</p>
                    </div>
                </div>
                
                <!-- Search Toggle (Desktop fixed, Mobile inline) -->
                <div class="relative mt-0 lg:mt-8 w-10 h-10 lg:w-full lg:h-auto">
                    <button id="mobile-search-toggle" class="lg:hidden p-2 bg-white/5 rounded-full border border-white/10">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </button>
                    <div id="search-container" class="hidden lg:block absolute right-0 top-12 lg:static lg:mt-0 w-64 lg:w-full z-50">
                        <input 
                            type="text" 
                            id="city-search" 
                            placeholder="Search location..." 
                            class="w-full bg-black/60 lg:bg-black/40 border border-white/10 rounded-xl py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all placeholder:text-slate-600 shadow-2xl lg:shadow-none"
                        >
                        <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-slate-900 border border-white/10 rounded-xl shadow-2xl z-50 overflow-hidden max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <div id="weather-summary" class="flex lg:flex-col gap-4 lg:gap-6 lg:flex-1">
                <div class="flex-1 lg:flex-none text-center p-4 lg:p-6 rounded-3xl bg-gradient-to-br from-indigo-500/10 to-blue-500/5 border border-indigo-500/20">
                    <div id="weather-icon-lg" class="mb-1 lg:mb-2">
                        <i data-lucide="cloud" class="w-10 h-10 lg:w-12 lg:h-12 text-slate-300 mx-auto"></i>
                    </div>
                    <div id="weather-temp" class="text-4xl lg:text-5xl font-black glow-text">--Â°</div>
                    <div id="weather-desc" class="text-indigo-300 font-bold uppercase tracking-widest text-[9px] lg:text-[10px] mt-1">Updating...</div>
                </div>

                <div class="grid grid-cols-2 gap-2 flex-1 lg:flex-none">
                    <div class="p-2 lg:p-3 rounded-2xl bg-white/5 border border-white/5 text-center">
                        <i data-lucide="sunrise" class="w-3.5 h-3.5 text-orange-400 mx-auto mb-1"></i>
                        <div id="sunrise-time" class="font-bold text-[10px] lg:text-[11px]">--:--</div>
                        <div class="text-[7px] uppercase text-slate-500 font-bold">Sunrise</div>
                    </div>
                    <div class="p-2 lg:p-3 rounded-2xl bg-white/5 border border-white/5 text-center">
                        <i data-lucide="sunset" class="w-3.5 h-3.5 text-purple-400 mx-auto mb-1"></i>
                        <div id="sunset-time" class="font-bold text-[10px] lg:text-[11px]">--:--</div>
                        <div class="text-[7px] uppercase text-slate-500 font-bold">Sunset</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-4 lg:p-8 space-y-6 lg:space-y-8 overflow-y-auto lg:overflow-y-auto custom-scrollbar">
            
            <div id="loading-overlay" class="flex flex-col items-center justify-center py-20 lg:h-full space-y-4">
                <div class="w-8 h-8 border-3 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-indigo-400 font-bold tracking-[0.2em] text-[10px] animate-pulse">SYNCING DATA STREAM</p>
            </div>

            <div id="dashboard-content" class="hidden space-y-6 lg:space-y-8">
                
                <!-- Radar -->
                <section>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-500">Live Radar Scan</h2>
                        <span class="px-2 py-0.5 bg-red-500/10 text-red-400 rounded text-[8px] font-black animate-pulse">LIVE MRMS</span>
                    </div>
                    <div class="radar-container border border-indigo-500/10">
                        <iframe id="radar-iframe" src="https://ephrataweather.github.io/MRMS/public/" scrolling="no"></iframe>
                    </div>
                </section>

                <!-- Hourly -->
                <section>
                    <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-3">24-Hour Forecast</h2>
                    <div class="forecast-scroll custom-scrollbar" id="hourly-grid"></div>
                </section>

                <!-- Adaptive Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 lg:gap-8">
                    <!-- Metrics -->
                    <div class="xl:col-span-5 space-y-6 lg:space-y-8">
                        <div class="grid grid-cols-2 gap-3" id="weather-details-grid"></div>
                        
                        <section>
                            <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-3">Bio-Allergen Scan</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-1 gap-3" id="pollen-types-list"></div>
                        </section>
                    </div>

                    <!-- 10 Day -->
                    <section class="xl:col-span-7">
                        <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-3">10-Day Deep Scan</h2>
                        <div class="space-y-2.5" id="daily-forecast"></div>
                    </section>
                </div>

                <!-- AQI -->
                <section class="p-5 lg:p-6 rounded-3xl bg-white/5 border border-white/5">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
                        <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-500">Atmospheric Quality Index</h2>
                        <div id="aqi-status-badge" class="w-fit px-4 py-1 rounded-full text-[10px] font-black uppercase">AQI: --</div>
                    </div>
                    <div id="pollutants-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3"></div>
                </section>
            </div>
            
            <footer class="text-center pb-6">
                <p class="text-[9px] text-slate-600 font-bold uppercase tracking-[0.3em]">Deep Environment v2.1 â€¢ Multi-Sensor Array</p>
            </footer>
        </main>
    </div>

    <!-- Mobile-First Modal -->
    <div id="detail-modal" class="fixed inset-0 z-[100] hidden items-end sm:items-center justify-center p-0 sm:p-6">
        <div class="w-full sm:max-w-xl glass-panel rounded-t-[2rem] sm:rounded-[2.5rem] p-6 lg:p-10 border-t sm:border border-white/20 shadow-2xl relative">
            <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-6 sm:hidden"></div>
            <button onclick="closeModal()" class="absolute top-6 right-6 p-2 text-slate-400 hover:text-white bg-white/5 rounded-full transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div id="modal-content" class="space-y-6"></div>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyBAjoVkrRrLPzv9MSrlWaWTFELT8KpJ41E"; 
        const DEFAULT_LAT = 40.1579;
        const DEFAULT_LNG = -76.2047;

        let globalWeather = {};
        let globalHourly = [];
        let globalDaily = [];
        let currentSunrise, currentSunset;

        const findValue = (obj, keys, defaultVal = 0) => {
            for (let key of keys) {
                const parts = key.split('.');
                let current = obj;
                for (let p of parts) { current = (current && typeof current === 'object') ? current[p] : undefined; }
                if (current !== undefined && current !== null) return current;
            }
            return defaultVal;
        };

        const calculateAccumulation = (liquidQpf, type) => {
            const liquid = parseFloat(liquidQpf) || 0;
            const pType = (type || "").toUpperCase();
            if (pType.includes("SNOW")) return (liquid * 10).toFixed(2);
            if (pType.includes("SLEET") || pType.includes("ICE")) return (liquid * 3).toFixed(2);
            return liquid.toFixed(2);
        };

        async function updateDashboard(lat, lng, cityName) {
            const loading = document.getElementById('loading-overlay');
            const content = document.getElementById('dashboard-content');
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            if(cityName) document.getElementById('location-name').innerText = cityName;

            try {
                const base = `https://weather.googleapis.com/v1`;
                const endpoints = {
                    pollen: `https://pollen.googleapis.com/v1/forecast:lookup?location.latitude=${lat}&location.longitude=${lng}&days=1&key=${API_KEY}`,
                    aqi: `https://airquality.googleapis.com/v1/currentConditions:lookup?key=${API_KEY}`,
                    weather: `${base}/currentConditions:lookup?location.latitude=${lat}&location.longitude=${lng}&unitsSystem=IMPERIAL&key=${API_KEY}`,
                    hourly: `${base}/forecast/hours:lookup?location.latitude=${lat}&location.longitude=${lng}&unitsSystem=IMPERIAL&hours=24&key=${API_KEY}`,
                    daily: `${base}/forecast/days:lookup?location.latitude=${lat}&location.longitude=${lng}&unitsSystem=IMPERIAL&days=10&pageSize=10&key=${API_KEY}`
                };

                const [pRes, aRes, wRes, hRes, dRes] = await Promise.all([
                    fetch(endpoints.pollen),
                    fetch(endpoints.aqi, { method: 'POST', body: JSON.stringify({ location: { latitude: lat, longitude: lng }, extraComputations: ["POLLUTANT_CONCENTRATION"] }) }),
                    fetch(endpoints.weather),
                    fetch(endpoints.hourly),
                    fetch(endpoints.daily)
                ]);

                globalWeather = await wRes.json();
                const hData = await hRes.json();
                const dData = await dRes.json();
                globalHourly = hData.forecastHours || [];
                globalDaily = dData.forecastDays || [];

                const sun = globalDaily[0]?.sunEvents || globalWeather.sunEvents || {};
                currentSunrise = sun.sunriseTime || sun.sunrise;
                currentSunset = sun.sunsetTime || sun.sunset;

                renderUI(await pRes.json(), await aRes.json());
            } catch (err) {
                loading.innerHTML = `<p class="text-red-400 text-xs font-black">LINK FAILURE: CHECK API KEY</p>`;
            }
        }

        function getWeatherIcon(desc, timeIso, apiIsDaytime = null) {
            const d = (desc || "").toLowerCase();
            let isNight = false;
            if (apiIsDaytime !== null) isNight = !apiIsDaytime;
            else {
                const check = timeIso ? new Date(timeIso).getTime() : Date.now();
                if (currentSunrise && currentSunset) {
                    isNight = (check < new Date(currentSunrise).getTime() || check > new Date(currentSunset).getTime());
                } else {
                    const h = new Date(check).getHours();
                    isNight = h < 6 || h > 19;
                }
            }
            if (d.includes('rain')) return 'cloud-rain';
            if (d.includes('thunder')) return 'cloud-lightning';
            if (d.includes('snow')) return 'cloud-snow';
            if (d.includes('cloud')) return 'cloud';
            return isNight ? 'moon' : 'sun';
        }

        function renderUI(pollen, aqi) {
            document.getElementById('loading-overlay').classList.add('hidden');
            const content = document.getElementById('dashboard-content');
            content.classList.remove('hidden');

            // Current
            const desc = findValue(globalWeather, ['weatherCondition.description.text'], "Clear");
            document.getElementById('weather-temp').innerText = `${Math.round(findValue(globalWeather, ['temperature.degrees']))}Â°`;
            document.getElementById('weather-desc').innerText = desc;
            document.getElementById('weather-icon-lg').innerHTML = `<i data-lucide="${getWeatherIcon(desc, null, globalWeather.isDaytime)}" class="w-10 h-10 lg:w-12 lg:h-12 text-indigo-400 mx-auto"></i>`;
            
            document.getElementById('sunrise-time').innerText = formatTime(currentSunrise);
            document.getElementById('sunset-time').innerText = formatTime(currentSunset);

            // Metrics
            const mb = findValue(globalWeather, ['airPressure.meanSeaLevelMillibars'], 0);
            const inHg = mb > 0 ? (mb * 0.02953).toFixed(2) : "0.00";
            const windSpd = Math.round(findValue(globalWeather, ['wind.speed.value']));
            const windDeg = findValue(globalWeather, ['wind.direction.degrees'], 0);

            const metrics = [
                { label: 'Humidity', val: `${findValue(globalWeather, ['relativeHumidity'])}%`, icon: 'droplets', color: 'text-blue-400' },
                { label: 'Barometer', val: `${inHg} in`, icon: 'gauge', color: 'text-indigo-400' },
                { label: 'UV Index', val: findValue(globalWeather, ['uvIndex']), icon: 'sun', color: 'text-yellow-400' },
                { label: 'Wind', val: `${windSpd} mph`, icon: 'wind', color: 'text-indigo-400', isWind: true }
            ];

            document.getElementById('weather-details-grid').innerHTML = metrics.map(m => `
                <div class="p-4 rounded-2xl bg-white/5 border border-white/5 metric-card flex items-center gap-3">
                    ${m.isWind ? `
                        <div class="wind-arrow-container" style="transform: rotate(${windDeg}deg)">
                            <i data-lucide="arrow-up" class="w-4 h-4 text-indigo-400"></i>
                        </div>
                    ` : `<i data-lucide="${m.icon}" class="w-5 h-5 ${m.color}"></i>`}
                    <div>
                        <div class="text-[8px] font-black text-slate-500 uppercase">${m.label}</div>
                        <div class="text-sm font-bold text-white">${m.val}</div>
                    </div>
                </div>
            `).join('');

            // Hourly
            document.getElementById('hourly-grid').innerHTML = globalHourly.map((h, i) => `
                <div onclick="showHourlyDetail(${i})" class="min-w-[100px] lg:min-w-[120px] p-3 lg:p-4 rounded-2xl bg-white/5 border border-white/5 text-center metric-card">
                    <div class="text-[8px] text-slate-500 font-black mb-2 uppercase">${formatTime(h.interval?.startTime)}</div>
                    <i data-lucide="${getWeatherIcon(h.weatherCondition?.description?.text, h.interval?.startTime)}" class="w-5 h-5 mx-auto mb-2 text-indigo-300"></i>
                    <div class="text-base lg:text-lg font-black">${Math.round(h.temperature?.degrees)}Â°</div>
                    <div class="text-[8px] text-blue-400 font-black uppercase mt-1">${h.precipitation?.probability?.percent || 0}% ðŸ’§</div>
                </div>
            `).join('');

            // Daily
            document.getElementById('daily-forecast').innerHTML = globalDaily.map((d, i) => {
                const day = d.daytimeForecast || {};
                const prob = day.precipitation?.probability?.percent || 0;
                return `
                <div onclick="showDailyDetail(${i})" class="p-4 rounded-2xl bg-white/5 border border-white/5 metric-card">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10">
                                <div class="text-[10px] font-black uppercase ${i===0?'text-indigo-400':'text-white'}">${i===0?'Today':new Date(d.interval?.startTime).toLocaleDateString('en-US',{weekday:'short'})}</div>
                            </div>
                            <i data-lucide="${getWeatherIcon(day.weatherCondition?.description?.text, d.interval?.startTime, true)}" class="w-4 h-4 text-slate-400"></i>
                            <div class="hidden sm:block text-[10px] font-bold text-slate-400 uppercase truncate max-w-[80px]">${day.weatherCondition?.description?.text || 'Clear'}</div>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="text-[10px] font-black text-blue-400">${prob}%</div>
                            <div class="flex flex-col items-end min-w-[40px]">
                                <span class="text-xs font-black">${Math.round(d.maxTemperature?.degrees)}Â°</span>
                                <span class="text-[9px] font-bold text-slate-600">${Math.round(d.minTemperature?.degrees)}Â°</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            // Pollen
            const pData = pollen.dailyInfo?.[0]?.pollenTypeInfo || [];
            document.getElementById('pollen-types-list').innerHTML = pData.map(t => `
                <div class="p-3 lg:p-4 rounded-2xl bg-white/5 border border-white/5 flex items-center justify-between">
                    <div>
                        <div class="text-[9px] font-black text-slate-500 uppercase">${t.displayName}</div>
                        <div class="text-xs font-bold text-indigo-300">${t.indexInfo?.category || 'None'}</div>
                    </div>
                    <div class="text-lg font-black">${t.indexInfo?.value || 0}<span class="text-[8px] text-slate-500 ml-0.5">/5</span></div>
                </div>
            `).join('');

            // AQI
            const idx = aqi.indexes?.[0];
            const badge = document.getElementById('aqi-status-badge');
            badge.innerText = `AQI: ${idx?.aqi || '--'}`;
            badge.className = `w-fit px-4 py-1 rounded-full text-[10px] font-black uppercase ${getAqiColor(idx?.category)}`;

            document.getElementById('pollutants-grid').innerHTML = (aqi.pollutants || []).map(p => `
                <div class="p-3 rounded-xl bg-black/40 border border-white/5 text-center">
                    <div class="text-[7px] font-black text-slate-500 uppercase mb-1 truncate">${p.displayName}</div>
                    <div class="font-black text-xs text-white">${Math.round(p.concentration?.value || 0)}</div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function getAqiColor(cat) {
            const c = (cat || "").toLowerCase();
            if(c.includes('good')) return "bg-emerald-500/20 text-emerald-400 border border-emerald-500/30";
            if(c.includes('moderate')) return "bg-yellow-500/20 text-yellow-400 border border-yellow-500/30";
            return "bg-red-500/20 text-red-400 border border-red-500/30";
        }

        function formatTime(iso) {
            if(!iso) return "--:--";
            return new Date(iso).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function closeModal() { document.getElementById('detail-modal').classList.add('hidden'); }
        
        function showHourlyDetail(i) {
            const h = globalHourly[i];
            const content = `
                <div class="flex items-center gap-4">
                    <div class="p-4 bg-indigo-500/10 rounded-2xl">
                        <i data-lucide="${getWeatherIcon(h.weatherCondition?.description?.text, h.interval?.startTime)}" class="w-8 h-8 text-indigo-400"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black">${formatTime(h.interval?.startTime)}</h3>
                        <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">${h.weatherCondition?.description?.text}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-white/5 rounded-2xl border border-white/5">
                        <div class="text-[9px] font-black text-slate-500 uppercase mb-1">Temperature</div>
                        <div class="text-xl font-black">${Math.round(h.temperature?.degrees)}Â°</div>
                    </div>
                    <div class="p-4 bg-white/5 rounded-2xl border border-white/5">
                        <div class="text-[9px] font-black text-slate-500 uppercase mb-1">Precipitation</div>
                        <div class="text-xl font-black text-blue-400">${h.precipitation?.probability?.percent || 0}%</div>
                    </div>
                </div>
            `;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');
            lucide.createIcons();
        }

        function showDailyDetail(i) {
            const d = globalDaily[i];
            const date = new Date(d.interval?.startTime).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const content = `
                <h3 class="text-xl font-black">${date}</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-white/5 rounded-2xl border border-white/10">
                        <div class="text-[9px] font-black text-slate-500 uppercase mb-1">High / Low</div>
                        <div class="text-xl font-black">${Math.round(d.maxTemperature?.degrees)}Â° <span class="text-slate-500 text-sm">/ ${Math.round(d.minTemperature?.degrees)}Â°</span></div>
                    </div>
                    <div class="p-4 bg-white/5 rounded-2xl border border-white/10">
                        <div class="text-[9px] font-black text-slate-500 uppercase mb-1">Humidity</div>
                        <div class="text-xl font-black">${d.daytimeForecast?.relativeHumidity || '--'}%</div>
                    </div>
                </div>
            `;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');
            lucide.createIcons();
        }

        // Mobile Search Toggle
        document.getElementById('mobile-search-toggle').onclick = () => {
            const container = document.getElementById('search-container');
            container.classList.toggle('hidden');
            if(!container.classList.contains('hidden')) document.getElementById('city-search').focus();
        };

        const searchInput = document.getElementById('city-search');
        const resultsBox = document.getElementById('search-results');
        let searchDebounce;

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchDebounce);
            const q = e.target.value;
            if (q.length < 3) { resultsBox.classList.add('hidden'); return; }
            searchDebounce = setTimeout(async () => {
                const res = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&limit=5`);
                const data = await res.json();
                resultsBox.innerHTML = data.features.map(f => `
                    <div class="p-4 hover:bg-white/10 cursor-pointer border-b border-white/5" onclick="selectCity(${f.geometry.coordinates[1]}, ${f.geometry.coordinates[0]}, '${f.properties.name}')">
                        <div class="text-xs font-black text-white">${f.properties.name}</div>
                        <div class="text-[9px] text-slate-500 uppercase font-bold">${f.properties.state || ''}, ${f.properties.country || ''}</div>
                    </div>
                `).join('');
                resultsBox.classList.remove('hidden');
            }, 300);
        });

        function selectCity(lat, lng, name) {
            updateDashboard(lat, lng, name);
            resultsBox.classList.add('hidden');
            searchInput.value = '';
            if(window.innerWidth < 1024) document.getElementById('search-container').classList.add('hidden');
        }

        window.onload = () => {
            lucide.createIcons();
            updateDashboard(DEFAULT_LAT, DEFAULT_LNG);
        };
    </script>
</body>
</html>
